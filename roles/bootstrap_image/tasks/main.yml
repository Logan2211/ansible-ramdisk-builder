---
# Copyright 2018, Logan Vig <logan2211@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Ensure unmounted proc, dev, sys in bootstrap
  command: umount "{{ item }}"
  register: unmount
  failed_when: "'not found' not in unmount.stderr and 'not mounted' not in unmount.stderr and unmount.rc != 0"
  changed_when: "unmount.rc == 0"
  with_items:
    - "{{ image_dir }}/proc"
    - "{{ image_dir }}/sys"
    - "{{ image_dir }}/dev"
  tags:
    - unmount-system-pre

- name: Delete stale image
  file:
    path: "{{ image_dir }}"
    state: absent
  tags:
    - image-delete-stale

- name: Prep image directory
  file:
    path: "{{ image_dir }}"
    state: directory
    mode: 0755
  tags:
    - image-destination-create

- name: Bootstrap image
  command: debootstrap
    --arch="{{ image_ubuntu_arch }}"
    --variant="{{ image_debootstrap_variant }}"
    --components="{{ image_debootstrap_components | join(',') }}"
    --include="{{ (image_bootstrap_include_packages + image_bootstrap_include_user_packages) | join(',') }}"
    --exclude="{{ (image_bootstrap_exclude_packages + image_bootstrap_exclude_user_packages) | join(',') }}"
    "{{ image_ubuntu_release }}" "{{ image_dir }}" "{{ image_ubuntu_apt_mirror }}"
  tags:
    - image-bootstrap-debootstrap

- name: Mount proc in bootstrap
  command: mount -t proc proc "{{ image_dir }}/proc"
  tags:
    - image-bootstrap-mount-proc

- name: Mount sys in bootstrap
  command: mount -t sysfs sysfs "{{ image_dir }}/sys"
  tags:
    - image-bootstrap-mount-sys

- name: Mount dev in bootstrap
  command: mount -o bind /dev "{{ image_dir }}/dev"
  tags:
    - image-bootstrap-mount-dev

- include_tasks: disable_autostart.yml
  when:
    - 'image_disable_service_autostart | bool'
